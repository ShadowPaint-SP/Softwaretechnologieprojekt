package campingplatz.reservation;

import org.salespointframework.catalog.Product;
import org.salespointframework.useraccount.UserAccount;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.CrudRepository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Set;
import java.util.UUID;

public interface ReservationRepository<U extends Product, T extends Reservation<U>> extends CrudRepository<T, UUID> {

    /**
     * Redeclare this function to make it apparent it exists
     * Implementation auto generated by Java Spring
     */
    @Override
    List<T> findAll();

    /**
     * Returns a List of Reservations with a given UserId.
     * Implementation auto generated by Java Spring
     */
    List<T> findByUserId(UserAccount.UserAccountIdentifier id);

    /**
     * Database query to return a List of reservations, that are
     * wholy or partially reserved in the given time interval
     *
     */
    @Query("""
                select r from #{#entityName} r
                where (r.begin >= :arrival and r.begin < :departure)
                or (r.end >= :arrival and r.end < :departure)
                or (r.begin < :arrival and r.end > :departure)
            """)
    List<T> findReservationsBetween(LocalDateTime arrival, LocalDateTime departure);

    /**
     * Database query to return a Stream of productIds corresponding to plots, that
     * are wholy or partially reserved in the given time interval
     *
     */
    @Query("""
                select distinct r.product from #{#entityName} r
                where (r.begin > :arrival and r.begin <= :departure)
                or (r.end > :arrival and r.end <= :departure)
                or (r.begin <= :arrival and r.end >= :departure)
            """)
    Set<U> findPlotsReservedBetween(LocalDateTime arrival, LocalDateTime departure);

    default Boolean productIsReservedIn(U product, LocalDateTime arrival, LocalDateTime departure) {
        return findPlotsReservedBetween(arrival, departure).contains(product);
    }

    default Boolean productIsAvailableIn(U product, LocalDateTime arrival, LocalDateTime departure) {
        return !findPlotsReservedBetween(arrival, departure).contains(product);
    }
}